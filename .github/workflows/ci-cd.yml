# .github/workflows/ci-cd.yml
name: CI + CD – marketinghub backend

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  packages: write

env:
  APP_DIR: /opt/marketinghub/app           # caminho no servidor
  VPS_IP: 191.252.92.222              # ← IP fixo do servidor


jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_ACTOR:  ${{ github.actor }}
    defaults:
      run:
        working-directory: backend/ads-service

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven     # :contentReference[oaicite:5]{index=5}

      - name: Cache manual do repositório Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: maven-

      # 1) build + deploy plain JAR
      - name: Build plain JAR e publicar no GitHub Packages
        run: |
          mvn -B -s ../settings.xml deploy \
              -Dspring-boot.repackage.skip=true \
              -DskipTests

      # 2) gerar o exec JAR
      - name: Repackage para JAR executável
        run: |
          mvn -B spring-boot:repackage \
              -Dspring-boot.repackage.classifier=exec \
              -DskipTests

      # 3) disponibilizar o exec JAR para o job deploy
      - name: Upload exec JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/ads-service/target/*-exec.jar

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: target

      # … passos de SSH/rsync exatamente como estavam …
      - name: Sincronizar JAR e reiniciar serviço
        run: |
          JAR=$(ls -S target/*-exec.jar | head -n 1)
          rsync -az --delete "$JAR" marketinghub@${VPS_IP}:${APP_DIR}/
          ssh marketinghub@${VPS_IP} "sudo -n systemctl restart marketinghub-backend.service"
